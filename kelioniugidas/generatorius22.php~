<?php
// generatorius.php - SU ATSTUMÅ² LOGIKA
session_start();
include("include/nustatymai.php");
include("include/functions.php");

if (!isset($_SESSION['prev']) || $_SESSION['ulevel'] == 0) {
    header("Location: index.php");
    exit;
}
$_SESSION['prev'] = "generatorius";
$db = mysqli_connect(DB_SERVER, DB_USER, DB_PASS, DB_NAME);
?>

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>MarÅ¡ruto generatorius</title>
    <link href="include/styles.css" rel="stylesheet" type="text/css">
    <style>
        .variant-box {
            border: 2px solid #ccc;
            padding: 15px;
            margin: 15px 0;
            background-color: #f9f9f9;
        }
        .nakvyne-row {
            background-color: #fffacd;
        }
    </style>
</head>
<body>
    <table class="center">
        <tr><td>
            <center><img src="include/top.png"></center>
        </td></tr>
        <tr><td>
<?php
include("include/meniu.php");
?>
            <h1>Automatinis marÅ¡ruto generatorius</h1>
            <p>Sistema pasiÅ«lys 3 marÅ¡rutÅ³ variantus pagal atstumÄ…</p>

<?php
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['generuoti'])) {
    $pradinis_miestas = trim($_POST['pradinis_miestas']);
    $datos_nuo = $_POST['datos_nuo'];
    $datos_iki = $_POST['datos_iki'];
    $pasirinkti_tipai = isset($_POST['tipai']) ? $_POST['tipai'] : array();
    
    $dienÅ³_skaicius = (strtotime($datos_iki) - strtotime($datos_nuo)) / 86400 + 1;
    
    if (empty($pradinis_miestas)) {
        echo "<p style='color: red;'>Ä®veskite pradinÄ¯ miestÄ…!</p>";
    } elseif (!empty($pasirinkti_tipai)) {
        $tipai_str = implode(',', array_map('intval', $pasirinkti_tipai));
        
        // GAUNAME VISUS OBJEKTUS
        $sql_visi = "SELECT o.*, ot.pavadinimas as tipo_pavadinimas,
                AVG(a.ivertinimas) as vid_ivertinimas
                FROM objektai o
                LEFT JOIN objektu_tipai ot ON o.tipo_id = ot.tipo_id
                LEFT JOIN atsiliepimai a ON o.objekto_id = a.objekto_id
                WHERE o.tipo_id IN ($tipai_str) 
                AND ot.ar_nakyvne = 0
                GROUP BY o.objekto_id";
        
        $result_visi = mysqli_query($db, $sql_visi);
        $visi_objektai = array();
        while ($obj = mysqli_fetch_assoc($result_visi)) {
            $visi_objektai[] = $obj;
        }
        
        if (count($visi_objektai) > 0) {
            echo "<div style='margin: 20px;'>";
            echo "<h2>Pasirinkite marÅ¡ruto variantÄ…</h2>";
            echo "<p><b>Pradinis miestas:</b> $pradinis_miestas | <b>TrukmÄ—:</b> $dienÅ³_skaicius d.</p>";
            
            // 3 VARIANTAI
            $variantai = array(
                array('pavadinimas' => 'Trumpas', 'per_diena' => 2),
                array('pavadinimas' => 'Vidutinis', 'per_diena' => 3),
                array('pavadinimas' => 'Intensyvus', 'per_diena' => 4)
            );
            
            foreach ($variantai as $idx => $variantas) {
                echo "<div class='variant-box'>";
                echo "<h3>VARIANTAS " . ($idx + 1) . ": " . $variantas['pavadinimas'] . " marÅ¡rutas</h3>";
                echo "<p>" . $variantas['per_diena'] . " objektai per dienÄ…</p>";
                
                // GENERUOJAME MARÅ RUTÄ„
                $marsrutas = array();
                $dabartine_vieta_id = null; // PradÅ¾ioje neÅ¾inome
                $per_diena = $variantas['per_diena'];
                
                // Surandame pradinÄ¯ objektÄ… (arÄiausiÄ… pradinio miesto)
                $pradinis_obj = null;
                foreach ($visi_objektai as $obj) {
                    if (stripos($obj['miestas'], $pradinis_miestas) !== false) {
                        $pradinis_obj = $obj;
                        break;
                    }
                }
                
                // Jei neranda tikslaus miesto, ima pirmÄ…
                if (!$pradinis_obj) {
                    $pradinis_obj = $visi_objektai[0];
                }
                
                $dabartine_vieta_id = $pradinis_obj['objekto_id'];
                $panaudoti_objektai = array();
                
                echo "<table border='1' cellspacing='0' cellpadding='8' width='100%'>";
                echo "<tr style='background-color: #f0f0f0;'>";
                echo "<th>Diena</th><th>Objektas</th><th>Tipas</th><th>Miestas</th><th>Atstumas</th><th>Laikas obj.</th><th>â˜…</th>";
                echo "</tr>";
                
                $bendras_laikas = 0;
                $bendras_atstumas = 0;
                
                for ($diena = 1; $diena <= $dienÅ³_skaicius; $diena++) {
                    for ($i = 0; $i < $per_diena; $i++) {
                        // IEÅ KOME ARÄŒIAUSIO OBJEKTO
                        $sql_artimas = "SELECT o.*, ot.pavadinimas as tipo_pavadinimas,
                                       AVG(a.ivertinimas) as vid_ivertinimas,
                                       ast.atstumas_km, ast.laikas as keliones_laikas
                                FROM objektai o
                                LEFT JOIN objektu_tipai ot ON o.tipo_id = ot.tipo_id
                                LEFT JOIN atsiliepimai a ON o.objekto_id = a.objekto_id
                                LEFT JOIN atstumas ast ON (
                                    ast.objekto1_id = $dabartine_vieta_id AND 
                                    ast.objekto2_id = o.objekto_id
                                )
                                WHERE o.tipo_id IN ($tipai_str)
                                AND ot.ar_nakyvne = 0
                                AND o.objekto_id NOT IN (" . implode(',', array_merge($panaudoti_objektai, array(0))) . ")
                                GROUP BY o.objekto_id
                                ORDER BY ast.atstumas_km ASC, vid_ivertinimas DESC
                                LIMIT 1";
                        
                        $result_artimas = mysqli_query($db, $sql_artimas);
                        
                        if ($result_artimas && mysqli_num_rows($result_artimas) > 0) {
                            $obj = mysqli_fetch_assoc($result_artimas);
                            
                            echo "<tr>";
                            echo "<td style='text-align: center;'><b>$diena</b></td>";
                            echo "<td>" . $obj['pavadinimas'] . "</td>";
                            echo "<td>" . $obj['tipo_pavadinimas'] . "</td>";
                            echo "<td>" . $obj['miestas'] . "</td>";
                            
                            $atstumas = $obj['atstumas_km'] ? $obj['atstumas_km'] . " km" : "0 km";
                            echo "<td>" . $atstumas . "</td>";
                            
                            echo "<td>" . $obj['rekomenduojamas_laikas'] . " min</td>";
                            
                            $rating = $obj['vid_ivertinimas'] ? number_format($obj['vid_ivertinimas'], 1) : "-";
                            echo "<td>" . $rating . "</td>";
                            echo "</tr>";
                            
                            $bendras_laikas += $obj['rekomenduojamas_laikas'] + ($obj['keliones_laikas'] ? $obj['keliones_laikas'] : 0);
                            $bendras_atstumas += $obj['atstumas_km'] ? $obj['atstumas_km'] : 0;
                            
                            $dabartine_vieta_id = $obj['objekto_id'];
                            $panaudoti_objektai[] = $obj['objekto_id'];
                        }
                    }
                    
                    // NAKVYNÄ– (pagal atstumÄ…!)
                    if ($diena < $dienÅ³_skaicius) {
                        $sql_nakv = "SELECT o.*, 
                                    AVG(a.ivertinimas) as vid_ivertinimas,
                                    ast.atstumas_km, ast.laikas as keliones_laikas
                            FROM objektai o
                            LEFT JOIN atsiliepimai a ON o.objekto_id = a.objekto_id
                            LEFT JOIN atstumas ast ON (
                                ast.objekto1_id = $dabartine_vieta_id AND 
                                ast.objekto2_id = o.objekto_id
                            )
                            WHERE o.tipo_id = 5
                            GROUP BY o.objekto_id
                            ORDER BY ast.atstumas_km ASC, vid_ivertinimas DESC
                            LIMIT 1";
                        
                        $result_nakv = mysqli_query($db, $sql_nakv);
                        
                        if ($result_nakv && mysqli_num_rows($result_nakv) > 0) {
                            $nakv = mysqli_fetch_assoc($result_nakv);
                            
                            echo "<tr class='nakvyne-row'>";
                            echo "<td style='text-align: center;'>ğŸŒ™</td>";
                            echo "<td>ğŸ¨ " . $nakv['pavadinimas'] . "</td>";
                            echo "<td>NakvynÄ—</td>";
                            echo "<td>" . $nakv['miestas'] . "</td>";
                            
                            $nakv_atstumas = $nakv['atstumas_km'] ? $nakv['atstumas_km'] . " km" : "0 km";
                            echo "<td>" . $nakv_atstumas . "</td>";
                            
                            echo "<td>-</td>";
                            
                            $nakv_rating = $nakv['vid_ivertinimas'] ? number_format($nakv['vid_ivertinimas'], 1) : "-";
                            echo "<td>" . $nakv_rating . "</td>";
                            echo "</tr>";
                            
                            $bendras_atstumas += $nakv['atstumas_km'] ? $nakv['atstumas_km'] : 0;
                            $dabartine_vieta_id = $nakv['objekto_id'];
                        }
                    }
                }
                
                echo "</table>";
                
                echo "<p style='margin-top: 10px;'>";
                echo "<b>Bendras atstumas:</b> $bendras_atstumas km | ";
                echo "<b>Bendras laikas:</b> " . round($bendras_laikas / 60, 1) . " val.";
                echo "</p>";
                
                echo "</div>";
            }
            
            echo "</div>";
            
        } else {
            echo "<p style='color: red;'>Nerasta objektÅ³!</p>";
        }
    } else {
        echo "<p style='color: red;'>Pasirinkite tipus!</p>";
    }
}
?>

            <div style="max-width: 500px; margin: 20px auto; background-color: white; padding: 20px; border: 1px solid #ccc;">
                <form method="POST" action="generatorius.php">
                    <h3>KelionÄ—s parametrai</h3>
                    
                    <p>
                        <label>Pradinis miestas:</label><br>
                        <input type="text" name="pradinis_miestas" required 
                               placeholder="pvz: Vilnius" style="width: 100%;">
                    </p>
                    
                    <p>
                        <label>PradÅ¾ios data:</label><br>
                        <input type="date" name="datos_nuo" required 
                               value="<?php echo date('Y-m-d'); ?>" style="width: 100%;">
                    </p>
                    
                    <p>
                        <label>Pabaigos data:</label><br>
                        <input type="date" name="datos_iki" required 
                               value="<?php echo date('Y-m-d', strtotime('+2 days')); ?>" style="width: 100%;">
                    </p>
                    
                    <h3>ObjektÅ³ tipai</h3>
<?php
$tipai_result = mysqli_query($db, "SELECT * FROM objektu_tipai WHERE ar_nakyvne = 0 ORDER BY pavadinimas");
while ($tipas = mysqli_fetch_assoc($tipai_result)) {
    echo "<label style='display: block;'>";
    echo "<input type='checkbox' name='tipai[]' value='" . $tipas['tipo_id'] . "'> ";
    echo $tipas['pavadinimas'];
    echo "</label>";
}
?>
                    
                    <p style="text-align: center; margin-top: 20px;">
                        <input type="submit" name="generuoti" value="Generuoti marÅ¡rutus">
                    </p>
                </form>
            </div>
        </td></tr>
    </table>
</body>
</html>
<?php mysqli_close($db); ?>
